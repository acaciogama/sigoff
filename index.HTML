<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SIGOF - SISTEMA INTEGRADO OFFLINE</title>
    <style>
        :root { 
            --bg: #f0f2f5; --panel: #ffffff; --text: #1c1e21; 
            --primary: #2e7d32; --secondary: #00bcd4; 
            --border: #ced4da; --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .container { max-width: 1300px; margin: 0 auto; padding: 20px; }
        .panel { background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 20px; }
        .header-main { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; text-transform: uppercase; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-cyan { background: #00bcd4; color: white; }
        .btn-red { background: #d32f2f; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        input, select { padding: 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: var(--text); width: 100%; box-sizing: border-box; }
        .search-box { margin: 20px 0; position: relative; }
        .search-box input { padding-left: 40px; border: 2px solid var(--primary); font-size: 16px; }
        .person-item { background: var(--panel); margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--border); border-left: 8px solid var(--primary); overflow: hidden; }
        .person-header { padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .person-content { display: none; padding: 20px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.02); }
        .person-item.open .person-content { display: block; }
        .mini-photo { width: 70px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border); }
        .tabs { display: flex; gap: 4px; }
        .tab-btn { padding: 12px 15px; border: none; background: #ddd; color: #555; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 11px; }
        .tab-btn.active { background: var(--panel); color: var(--primary); border-top: 4px solid var(--primary); }
        .count-badge { background: #555; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
         #previewModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; overflow-y: auto; }
        .modal-body { width: 90%; max-width: 700px; margin: 50px auto; background: var(--panel); padding: 30px; border-radius: 12px; text-align: center; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #000; }
    </style>
</head>
<body>

<div id="telaMunicipios">
    <div class="container" style="text-align: center; padding-top: 50px;">
        <h1 style="font-size: 4em; color: var(--primary); margin: 0;">SIGOF</h1>
        <p style="letter-spacing: 3px; font-weight: bold; opacity: 0.6;">VERS√ÉO OFICIAL</p>
        <div class="panel" style="max-width: 600px; margin: 30px auto;">
            <input type="text" id="novoMun" placeholder="NOME DO NOVO MUNIC√çPIO..." style="text-align: center; margin-bottom: 15px;">
            <button class="btn btn-green" style="width: 100%;" onclick="criarM()">ADICIONAR MUNIC√çPIO</button>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-cyan" onclick="abrirOpcoesBackup()">üíæ BACKUP</button>
                <button class="btn btn-green" onclick="document.getElementById('fB').click()">üì• RESTAURAR</button>
                <input type="file" id="fB" style="display:none" onchange="importarBackup(this)">
            </div>
        </div>
        <div id="gridMun" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div>
    </div>
</div>

<div id="telaPrincipal" style="display:none">
    <div class="container">
        <div class="panel">
            <div class="header-main">
                <button class="btn btn-green" onclick="location.reload()">‚Üê VOLTAR</button>
                <div style="display:flex; align-items:center; gap:15px">
                    <h2 id="titMun" style="margin:0">MUNIC√çPIO</h2>
                    <button class="btn btn-red" style="font-size: 9px; padding: 5px 10px;" onclick="limparListaMuni()">üóëÔ∏è LIMPAR LISTA</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-cyan" onclick="alternarVisao(false)">F√çSICO</button>
                    <button class="btn btn-green" onclick="alternarVisao(true)">FINANCEIRO</button>
                    <button class="btn btn-red" onclick="abrirRelatorio()">üìä RELAT√ìRIO CSV</button>
                </div>
            </div>
            
            <div class="grid-inputs">
                <input type="text" id="addN" placeholder="NOME COMPLETO *">
                <input type="text" id="addC" placeholder="CPF *" oninput="handleCPF(this)" maxlength="14">
                <input type="text" id="addCom" placeholder="COMUNIDADE">
                <input type="text" id="addP" placeholder="PLACA">
                <input type="text" id="addT" placeholder="TELEFONE">
                <input type="text" id="addG" placeholder="GPS">
                <input type="text" id="addNIS" placeholder="NIS">
                
                <!-- NOVAS DATAS COM M√ÅSCARA -->
                <input type="text" id="addDtEx1" placeholder="DATA INICIO" oninput="handleData(this)" maxlength="10">
                <input type="text" id="addDtEx2" placeholder="DATA FIM" oninput="handleData(this)" maxlength="10">
                
                <input type="text" id="addPed" placeholder="NOME PEDREIRO">
                <input type="text" id="addPedC" placeholder="CPF PEDREIRO" oninput="handleCPF(this)" maxlength="14">
                <div style="display: flex; align-items: center; gap: 5px; background: #eee; padding: 10px; border-radius: 6px;">
                    <input type="checkbox" id="addCurso" style="width: 20px;"> <label for="addCurso" style="font-size: 11px; font-weight: bold;">FEZ CURSO?</label>
                </div>
                <button class="btn btn-green" onclick="adicionarManual()">SALVAR</button>
                <button class="btn btn-cyan" onclick="document.getElementById('fImport').click()">üì• IMPORTAR TXT/CSV</button>
                <input type="file" id="fImport" style="display:none" accept=".csv,.txt" onchange="importarArquivo()">
            </div>

            <div class="search-box">
                <input type="text" id="inputBusca" placeholder="üîç PESQUISAR POR NOME, CPF, PLACA OU COMUNIDADE..." oninput="render()">
            </div>

            <div id="abasFisico" class="tabs">
                <button class="tab-btn active" id="tabG" onclick="setTab('G')">GERAL <span class="count-badge" id="cG">0</span></button>
                <button class="tab-btn" id="tabP" onclick="setTab('P')">PENDENTES <span class="count-badge" id="cP">0</span></button>
                <button class="tab-btn" id="tabF" onclick="setTab('F')">COM FOTOS <span class="count-badge" id="cF">0</span></button>
                <button class="tab-btn" id="tabI" onclick="setTab('I')">IMPRESSOS <span class="count-badge" id="cI">0</span></button>
                <button class="tab-btn" id="tabCC" onclick="setTab('CC')">COM CURSO <span class="count-badge" id="cCC">0</span></button>
                <button class="tab-btn" id="tabSC" onclick="setTab('SC')">SEM CURSO <span class="count-badge" id="cSC">0</span></button>
                <button class="tab-btn" id="tabL" onclick="setTab('L')">LIXEIRA <span class="count-badge" id="cL">0</span></button>
                <button class="btn btn-red" id="btnEsvaziarLixeira" style="display:none; margin-left:10px; font-size:9px" onclick="esvaziarLixeiraPermanente()">‚ò¢Ô∏è ESVAZIAR LIXEIRA</button>
                
                <select id="ordenarPor" onchange="render()" style="width: 180px; margin-left: auto; height: 35px; font-size: 11px;">
                    <option value="nome">ORDEM: NOME</option>
                    <option value="cpf">ORDEM: CPF</option>
                    <option value="com">ORDEM: COMUNIDADE</option>
                    <option value="timestamp">ORDEM: CADASTRO</option>
                </select>
            </div>

            <div id="abasFinan" class="tabs" style="display:none">
                <button class="tab-btn" id="tabFP" onclick="setTab('FP')">FAM. PAGAS <span class="count-badge" id="cFP">0</span></button>
                <button class="tab-btn" id="tabFA" onclick="setTab('FA')">FAM. A PAGAR <span class="count-badge" id="cFA">0</span></button>
                <button class="tab-btn" id="tabPP" onclick="setTab('PP')">PEDR. PAGOS <span class="count-badge" id="cPP">0</span></button>
                <button class="tab-btn" id="tabPA" onclick="setTab('PA')">PEDR. A PAGAR <span class="count-badge" id="cPA">0</span></button>
            </div>
            
            <div id="lista" style="margin-top: 15px;"></div>
        </div>
    </div>
</div> <!-- FECHAMENTO DA TELA PRINCIPAL AQUI -->

<!-- O PREVIEW MODAL AGORA EST√Å FORA DE TODAS AS TELAS -->
<div id="previewModal">
    <div class="modal-body">
        <h2 id="modalTit">OP√á√ïES</h2>
        <div id="modalContent"></div>
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button class="btn btn-cyan" id="btnConfirmarPrint" style="display:none">‚úÖ CONFIRMAR IMPRESS√ÉO</button>
            <button class="btn btn-red" onclick="fecharModal()">FECHAR</button>
        </div>
    </div>
</div>


<script>
    let db, muniAtual = null, aba = 'P', aberto = null, modoEdicao = null, vistaFin = false;

    const request = indexedDB.open("SIGOF_OFICIAL", 2);

    request.onupgradeneeded = e => {
        let d = e.target.result;
        if (!d.objectStoreNames.contains("munis")) d.createObjectStore("munis", { keyPath: "id" });
        if (d.objectStoreNames.contains("cards")) d.deleteObjectStore("cards");
        d.createObjectStore("cards", { keyPath: "cpf" }); 
    };

    request.onsuccess = e => { db = e.target.result; listarMunicipios(); };

    function criarM() {
        const n = document.getElementById('novoMun').value.trim().toUpperCase();
        if(!n) return;
        const tx = db.transaction("munis", "readwrite");
        tx.objectStore("munis").add({ id: n });
        tx.oncomplete = () => { document.getElementById('novoMun').value = ""; listarMunicipios(); };
    }

    function listarMunicipios() {
        const g = document.getElementById('gridMun'); g.innerHTML = "";
        db.transaction("munis").objectStore("munis").getAll().onsuccess = e => {
            e.target.result.forEach(m => {
                const d = document.createElement('div'); d.className = "panel";
                d.style.display = "flex"; d.style.justifyContent = "space-between";
                d.innerHTML = `<strong onclick="abrirM('${m.id}')" style="cursor:pointer; font-size:18px">${m.id}</strong>
                               <button class="btn btn-red" onclick="excluirM('${m.id}')">X</button>`;
                g.appendChild(d);
            });
        };
    }
    function excluirM(id) { 
        if(confirm(`Excluir o munic√≠pio ${id} e todos os seus dados?`) && prompt("Senha:") === 'admin') { 
            const tx = db.transaction(["munis", "cards"], "readwrite"); 
            tx.objectStore("munis").delete(id); 
            const store = tx.objectStore("cards"); 
            store.getAll().onsuccess = e => { 
                e.target.result.filter(c => c.muni === id).forEach(c => store.delete(c.cpf)); 
            }; 
            tx.oncomplete = listarMunicipios; 
        } 
    }

    function limparListaMuni() {
        if(confirm(`ATEN√á√ÉO: Deseja apagar TODOS os benefici√°rios de ${muniAtual}?`) && prompt("Senha de seguran√ßa:") === 'admin') {
            const tx = db.transaction("cards", "readwrite");
            const store = tx.objectStore("cards");
            store.getAll().onsuccess = e => {
                e.target.result.filter(c => c.muni === muniAtual).forEach(c => store.delete(c.cpf));
                tx.oncomplete = render;
            };
        }
    }

        function abrirM(id) {
        muniAtual = id;
        document.getElementById('telaMunicipios').style.display='none';
        document.getElementById('telaPrincipal').style.display='block';
        document.getElementById('titMun').innerText = id;
        aba = 'G'; // Come√ßa na Geral
        render();
    }


            function adicionarManual() {
        const nome = document.getElementById('addN').value.trim().toUpperCase();
        const cpf = document.getElementById('addC').value.trim();
        const pedCpf = document.getElementById('addPedC').value.trim();
        
        if (!nome || !cpf || !muniAtual) return alert("Nome, CPF e Munic√≠pio s√£o obrigat√≥rios.");

        // Valida√ß√£o do CPF do Benefici√°rio
        if (!validarCPF(cpf)) {
            alert("‚ö†Ô∏è CPF DO BENEFICI√ÅRIO INV√ÅLIDO!");
            document.getElementById('addC').focus();
            return;
        }

        // Valida√ß√£o do CPF do Pedreiro (se preenchido)
        if (pedCpf && !validarCPF(pedCpf)) {
            alert("‚ö†Ô∏è CPF DO PEDREIRO INV√ÅLIDO!");
            document.getElementById('addPedC').focus();
            return;
        }
        
        const tx = db.transaction("cards", "readwrite");
        tx.objectStore("cards").put({ 
            muni: muniAtual, 
            cpf: cpf, 
            nome: nome,
            com: document.getElementById('addCom').value.trim().toUpperCase(),
            placa: document.getElementById('addP').value.trim(), 
            tel: document.getElementById('addT').value.trim(),
            gps: document.getElementById('addG').value.trim(), 
            nis: document.getElementById('addNIS').value.trim(), // NOVO CAMPO
            curso: document.getElementById('addCurso').checked, // NOVO CAMPO (Checkbox)
            pedNome: document.getElementById('addPed').value.trim().toUpperCase(),
            pedCpf: pedCpf, 
            paga: false, 
            pedPaga: false, 
            f1: null, 
            f2: null, 
            impresso: false, 
            lixeira: false, 
            timestamp: Date.now()
        });
        tx.oncomplete = () => { limparFormulario(); render(); };
    }




        function render() {
    document.getElementById('btnEsvaziarLixeira').style.display = (aba === 'L' && !vistaFin) ? 'inline-flex' : 'none';   
    const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
    const cont = document.getElementById('lista'); 
    cont.innerHTML = "";
    const busca = document.getElementById('inputBusca').value.toUpperCase().trim();
    const ord = document.getElementById('ordenarPor').value;

    db.transaction("cards").objectStore("cards").getAll().onsuccess = e => {
        let cards = e.target.result.filter(c => c.muni === muniAtual);
        
        if (busca) {
            cards = cards.filter(c => 
                (c.nome && c.nome.toUpperCase().includes(busca)) || 
                (c.cpf && c.cpf.includes(busca)) || 
                (c.com && c.com.toUpperCase().includes(busca)) || 
                (c.placa && c.placa.toUpperCase().includes(busca))
            );
        }

        // Atualiza√ß√£o dos Contadores
        document.getElementById('cG').innerText = cards.filter(c => !c.lixeira).length;
        document.getElementById('cP').innerText = cards.filter(c => (!c.f1 || !c.f2) && !c.impresso && !c.lixeira).length;
        document.getElementById('cF').innerText = cards.filter(c => c.f1 && c.f2 && !c.impresso && !c.lixeira).length;
        document.getElementById('cI').innerText = cards.filter(c => c.impresso && !c.lixeira).length;
        document.getElementById('cCC').innerText = cards.filter(c => c.curso && !c.lixeira).length; 
        document.getElementById('cSC').innerText = cards.filter(c => !c.curso && !c.lixeira).length; 
        document.getElementById('cL').innerText = cards.filter(c => c.lixeira).length;
        document.getElementById('cFP').innerText = cards.filter(c => c.paga && !c.lixeira).length;
        document.getElementById('cFA').innerText = cards.filter(c => !c.paga && !c.lixeira).length;
        document.getElementById('cPP').innerText = cards.filter(c => c.pedPaga && !c.lixeira).length;
        document.getElementById('cPA').innerText = cards.filter(c => !c.pedPaga && !c.lixeira).length;

        cards.sort((a,b) => (ord === 'timestamp') ? a.timestamp - b.timestamp : (a[ord]||"").toString().localeCompare((b[ord]||"").toString()));

        let idx = 1;
        cards.forEach(c => {
            const temF = c.f1 && c.f2;
            let vis = false;
            
            if(!vistaFin) {
                vis = (aba==='G' && !c.lixeira) || 
                      (aba==='P' && !temF && !c.impresso && !c.lixeira) || 
                      (aba==='F' && temF && !c.impresso && !c.lixeira) || 
                      (aba==='I' && c.impresso && !c.lixeira) || 
                      (aba==='CC' && c.curso && !c.lixeira) ||  
                      (aba==='SC' && !c.curso && !c.lixeira) || 
                      (aba==='L' && c.lixeira);
            } else {
                vis = !c.lixeira && (
                    (aba==='FP' && c.paga) || (aba==='FA' && !c.paga) || 
                    (aba==='PP' && c.pedPaga) || (aba==='PA' && !c.pedPaga)
                );
            }
            
            if(vis) {
                const isEd = modoEdicao === c.cpf; 
                const d = document.createElement('div'); 
                d.className = `person-item ${aberto === c.cpf ? 'open' : ''}`;
                
                const getF = (f) => {
                    if (!f) return null;
                    return (f instanceof FileList && f.length > 0) ? f[0] : f;
                };

                const url1 = c.f1 ? URL.createObjectURL(getF(c.f1)) : '';
                const url2 = c.f2 ? URL.createObjectURL(getF(c.f2)) : '';

                d.innerHTML = `<div class="person-header" onclick="toggle('${c.cpf}')"> 
                        <span><strong>#${idx}</strong> | ${c.nome}</span>
                        <div style="display:flex; gap:5px">
                             ${url1 ? `<img src="${url1}" class="mini-photo">` : ''}
                             ${url2 ? `<img src="${url2}" class="mini-photo">` : ''}
                        </div>
                    </div>
                    <div class="person-content">
                        <div class="grid-inputs">
                            <input id="e-n-${c.cpf}" value="${c.nome}" ${!isEd?'disabled':''}> 
                            <input id="e-c-${c.cpf}" value="${c.cpf}" oninput="handleCPF(this)" maxlength="14" ${!isEd?'disabled':''}>
                            <input id="e-com-${c.cpf}" value="${c.com}" placeholder="COMUNIDADE" ${!isEd?'disabled':''}>
                            <input id="e-p-${c.cpf}" value="${c.placa}" placeholder="PLACA" ${!isEd?'disabled':''}>
                            <input id="e-t-${c.cpf}" value="${c.tel||''}" placeholder="TELEFONE" ${!isEd?'disabled':''}>
                            <input id="e-g-${c.cpf}" value="${c.gps||''}" placeholder="GPS" ${!isEd?'disabled':''}>
                            <input id="e-nis-${c.cpf}" value="${c.nis||''}" placeholder="NIS" ${!isEd?'disabled':''}>
                            
                            <!-- NOVOS CAMPOS DE DATA NO CARD -->
                            <input id="e-dt1-${c.cpf}" value="${c.dtExtra1||''}" oninput="handleData(this)" placeholder="DATA INICIO" maxlength="10" ${!isEd?'disabled':''}>
                            <input id="e-dt2-${c.cpf}" value="${c.dtExtra2||''}" oninput="handleData(this)" placeholder="DATA FIM" maxlength="10" ${!isEd?'disabled':''}>

                            <input id="e-pn-${c.cpf}" value="${c.pedNome}" placeholder="PEDREIRO" ${!isEd?'disabled':''}>
                            <input id="e-pc-${c.cpf}" value="${c.pedCpf}" oninput="handleCPF(this)" maxlength="14" placeholder="CPF PEDR" ${!isEd?'disabled':''}>
                        </div>
                        <div style="margin-top:15px; display:flex; gap:10px">
                            ${isEd?`<button class="btn btn-green" onclick="salvarE('${c.cpf}')">SALVAR</button>`:`<button class="btn btn-cyan" onclick="ativarE('${c.cpf}')">EDITAR</button>`}
                            <button class="btn btn-cyan" onclick="prepararImp('${c.cpf}')">IMPRIMIR</button>
                            <button class="btn btn-red" onclick="limparF('${c.cpf}')">LIMPAR FOTOS</button>
                            <button class="btn btn-red" onclick="statusCard('${c.cpf}','lixeira',${!c.lixeira})">${c.lixeira?'RESTAURAR':'LIXEIRA'}</button>
                        </div>
                        <div style="margin-top:10px">
                            <label><input type="checkbox" onchange="statusCard('${c.cpf}','paga',this.checked)" ${c.paga?'checked':''}> FAM√çLIA PAGA</label>
                            <label style="margin-left:15px"><input type="checkbox" onchange="statusCard('${c.cpf}','pedPaga',this.checked)" ${c.pedPaga?'checked':''}> PEDREIRO PAGO</label>
                            <label style="margin-left:15px; font-weight: bold; color: var(--primary)"><input type="checkbox" onchange="statusCard('${c.cpf}','curso',this.checked)" ${c.curso?'checked':''}> CONCLUIU CURSO</label>
                        </div>
                        
                        <!-- √ÅREA DO PDF -->
                        <div style="margin-top:10px; padding:8px; border:1px dashed #ccc; background:#f9f9f9; display:flex; align-items:center; gap:10px; border-radius:8px">
                            <strong style="font-size:11px">PDF:</strong> 
                            <input type="file" accept=".pdf" onchange="upPdf('${c.cpf}', this)" style="font-size:11px; width:auto">
                            ${c.docPdf ? `<button class="btn btn-green" onclick="abrirPdf('${c.cpf}')" style="padding:4px 8px; font-size:10px">üìÑ VER PDF</button>` : '<span style="font-size:10px; color:#999">SEM ARQUIVO</span>'}
                        </div>

                        <div style="margin-top:15px">FOTOS: <input type="file" onchange="upF('${c.cpf}',this,'f1')"> <input type="file" onchange="upF('${c.cpf}',this,'f2')"></div>
                    </div>`;
                cont.appendChild(d);
                idx++;
            }
        });
        window.scrollTo(0, scrollPos);
    };
}



    
    function prepararImp(cpf) {
        document.getElementById('modalTit').innerText = "OP√á√ïES DE IMPRESS√ÉO";
        document.getElementById('modalContent').innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px">
                <button class="btn btn-green" onclick="dispararImp('${cpf}', 'SIGA')">MODO SIGA</button>
                <button class="btn btn-cyan" onclick="dispararImp('${cpf}', 'SEADES')">MODO SEADES</button>
            </div>`;
        document.getElementById('previewModal').style.display = 'block';
    }

        function toggle(id) { 
        // Se estiver em modo de edi√ß√£o, permitimos fechar para destravar o sistema
        if(modoEdicao && modoEdicao !== id) {
            if(!confirm("Existe uma edi√ß√£o em andamento. Deseja descartar as altera√ß√µes?")) return;
            modoEdicao = null; 
        }
        aberto = (aberto === id) ? null : id; 
        render(); 
    }

    function ativarE(id) { modoEdicao = id; render(); }

        function salvarE(id) {
    const novoCpf = document.getElementById(`e-c-${id}`).value.trim();
    const novoPedCpf = document.getElementById(`e-pc-${id}`).value.trim();
    
    // Valida CPF Benefici√°rio
    if (!validarCPF(novoCpf)) {
        alert("‚ö†Ô∏è CPF DO BENEFICI√ÅRIO INV√ÅLIDO!");
        document.getElementById(`e-c-${id}`).focus();
        return; 
    }

    // Valida CPF Pedreiro (se preenchido)
    if (novoPedCpf && !validarCPF(novoPedCpf)) {
        alert("‚ö†Ô∏è CPF DO PEDREIRO INV√ÅLIDO!");
        document.getElementById(`e-pc-${id}`).focus();
        return;
    }

    const tx = db.transaction("cards","readwrite"); 
    const s = tx.objectStore("cards");
    s.get(id).onsuccess = e => {
        const d = e.target.result;
        if(!d) return;
        
        d.nome = document.getElementById(`e-n-${id}`).value.toUpperCase().trim(); 
        d.com = document.getElementById(`e-com-${id}`).value.toUpperCase().trim(); 
        d.placa = document.getElementById(`e-p-${id}`).value.trim(); 
        d.tel = document.getElementById(`e-t-${id}`).value.trim(); 
        d.gps = document.getElementById(`e-g-${id}`).value.trim(); 
        d.nis = document.getElementById(`e-nis-${id}`).value.trim();
        
        // NOVAS DATAS SALVAS AQUI:
        d.dtExtra1 = document.getElementById(`e-dt1-${id}`).value;
        d.dtExtra2 = document.getElementById(`e-dt2-${id}`).value;

        d.pedNome = document.getElementById(`e-pn-${id}`).value.toUpperCase().trim(); 
        d.pedCpf = novoPedCpf; 

        // Se o CPF mudou, deleta o registro antigo e cria o novo (pois CPF √© a chave)
        if (novoCpf !== id) { 
            s.delete(id); 
            d.cpf = novoCpf; 
        }
        
        s.put(d); 
        tx.oncomplete = () => { 
            modoEdicao = null; 
            render(); 
        };
    }
}

    function statusCard(id, campo, val) { 
        const tx = db.transaction("cards","readwrite"); 
        const s = tx.objectStore("cards"); 
        s.get(id).onsuccess = e => { 
            const d = e.target.result; 
            if(!d) return;
            d[campo] = val; 
            s.put(d); 
            tx.oncomplete = () => render(); 
        } 
    }


    function limparF(id) { 
        if(confirm("Deseja apagar as fotos deste benefici√°rio?")) { 
            const tx = db.transaction("cards","readwrite"); 
            const s = tx.objectStore("cards");
            s.get(id).onsuccess = e => {
                const d = e.target.result;
                if(!d) return;
                d.f1 = null; d.f2 = null;
                s.put(d);
                tx.oncomplete = render;
            };
        } 
    }

           function abrirRelatorio() {
        document.getElementById('modalTit').innerText = "EXPORTAR RELAT√ìRIO CSV";
        document.getElementById('modalContent').innerHTML = `
            <div class="filter-options">
                <label><input type="checkbox" class="rel-f" value="pend"> PENDENTES</label>
                <label><input type="checkbox" class="rel-f" value="foto"> COM FOTO</label>
                <label><input type="checkbox" class="rel-f" value="imp"> IMPRESSO</label>
                <label><input type="checkbox" class="rel-f" value="curso_sim"> COM CURSO</label>
                <label><input type="checkbox" class="rel-f" value="curso_nao"> SEM CURSO</label>
                <label><input type="checkbox" class="rel-f" value="fin"> FINANCEIRO</label>
            </div>
            <button class="btn btn-green" style="width:100%; margin-top:10px" onclick="processarCSV()">GERAR RELAT√ìRIO</button>
        `;
        document.getElementById('previewModal').style.display = 'block';
    }

    function processarCSV() {
    const filters = Array.from(document.querySelectorAll('.rel-f:checked')).map(cb => cb.value);
    if (filters.length === 0) return alert("Selecione ao menos uma op√ß√£o!");

    db.transaction("cards").objectStore("cards").getAll().onsuccess = e => {
        let cards = e.target.result.filter(c => c.muni === muniAtual && !c.lixeira);
        
        let result = cards.filter(c => {
            const temF = c.f1 && c.f2;
            if (filters.includes('pend') && (!temF && !c.impresso)) return true;
            if (filters.includes('foto') && (temF && !c.impresso)) return true;
            if (filters.includes('imp') && c.impresso) return true;
            if (filters.includes('curso_sim') && c.curso) return true;
            if (filters.includes('curso_nao') && !c.curso) return true;
            if (filters.includes('fin')) return true;
            return false;
        });

        if (result.length === 0) return alert("Nenhum dado encontrado para os filtros selecionados!");

        // CABE√áALHO ORDENADO: CPF -> COMUNIDADE -> NIS -> DATAS -> CURSO
        let csv = "N#;NOME;CPF;COMUNIDADE;NIS;INICIO;FIM;CURSO;PLACA;FAMILIA PAGA;PEDREIRO PAGO;STATUS\n";
        
        result.forEach((c, i) => {
            let st = c.impresso ? "IMPRESSO" : (c.f1 && c.f2 ? "FOTO OK" : "PENDENTE");
            let cursoStatus = c.curso ? "SIM" : "N√ÉO";
            
            // Pega as novas datas dtExtra1 e dtExtra2 salvas no card
            let vistoria = c.dtExtra1 || "";
            let entrega = c.dtExtra2 || "";
            
            // Montagem da linha seguindo rigorosamente a ordem do cabe√ßalho
            csv += `${i+1};${c.nome};${c.cpf};${c.com || ''};${c.nis || ''};${vistoria};${entrega};${cursoStatus};${c.placa || ''};${c.paga?'SIM':'N√ÉO'};${c.pedPaga?'SIM':'N√ÉO'};${st}\n`;
        });

        const blob = new Blob(["\ufeff" + csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = `SIGOF_RELATORIO_${muniAtual}.csv`; 
        a.click();
        
        // Limpeza de mem√≥ria e fechar modal
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        fecharModal();
    };
}

   function abrirOpcoesBackup() {
    const modal = document.getElementById('previewModal');
    const tit = document.getElementById('modalTit');
    const cont = document.getElementById('modalContent');

    tit.innerText = "ESCOLHA O TIPO DE BACKUP";
    cont.innerHTML = `
        <div style="display:grid; gap:10px; margin-top:15px">
            <button class="btn btn-green" onclick="exportarBackup(true)">üì¶ BACKUP COMPLETO (FOTOS + PDF)</button>
            <button class="btn btn-cyan" onclick="exportarBackup(false)">üìÑ BACKUP LEVE (DADOS + PDF)</button>
        </div>`;
    
    // Esconde o bot√£o de impress√£o caso tenha ficado aberto de outra vez
    document.getElementById('btnConfirmarPrint').style.display = 'none';
    
    modal.style.display = 'block';
}


async function exportarBackup(comFotos) {
    const tx = db.transaction(["munis", "cards"], "readonly");
    const munis = await new Promise(res => tx.objectStore("munis").getAll().onsuccess = e => res(e.target.result));
    const cards = await new Promise(res => tx.objectStore("cards").getAll().onsuccess = e => res(e.target.result));
    
    const processados = await Promise.all(cards.map(async c => {
        const k = {...c};
        
        const toBase64 = (file) => new Promise((resolve) => {
            if (!file) return resolve(null);
            // Se for FileList, pega o arquivo, sen√£o usa o Blob direto
            const blob = (file instanceof FileList && file.length > 0) ? file[0] : file;
            if (!(blob instanceof Blob)) return resolve(null);

            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(blob);
        });

        // PDF sempre vai (como Base64)
        k.pdfB = await toBase64(c.docPdf);

        if (comFotos) {
            k.f1b = await toBase64(c.f1);
            k.f2b = await toBase64(c.f2);
        }

        // Remove os bin√°rios para o JSON aceitar
        delete k.f1; delete k.f2; delete k.docPdf;
        return k;
    }));

    const blob = new Blob([JSON.stringify({ munis, cards: processados })], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = comFotos ? `SIGOF_FULL.json` : `SIGOF_LEVE.json`;
    a.click();
    fecharModal();
}


async function exportarBackup(comFotos) {
    const tx = db.transaction(["munis", "cards"], "readonly");
    const munis = await new Promise(res => tx.objectStore("munis").getAll().onsuccess = e => res(e.target.result));
    const cards = await new Promise(res => tx.objectStore("cards").getAll().onsuccess = e => res(e.target.result));
    
    const processados = await Promise.all(cards.map(async c => {
        const k = {...c};
        
        // Fun√ß√£o auxiliar para converter arquivos para Base64
        const file2base64 = (f) => new Promise(r => { 
            if(!f) return r(null);
            const rd = new FileReader(); 
            rd.onload = () => r(rd.result); 
            rd.readAsDataURL(f instanceof FileList ? f[0] : f);
        });

        if (comFotos) {
            k.f1b = await file2base64(c.f1);
            k.f2b = await file2base64(c.f2);
        }
        
        // PDF sempre vai no backup
        k.pdfB = await file2base64(c.docPdf);

        delete k.f1; delete k.f2; delete k.docPdf;
        return k;
    }));

    const blob = new Blob([JSON.stringify({munis, cards: processados})], {type: "application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = comFotos ? `SIGOF_BACKUP_COMPLETO.json` : `SIGOF_BACKUP_LEVE.json`;
    a.click();
    fecharModal();
}


    function importarBackup(input) {
    if (!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async e => {
        try {
            const d = JSON.parse(e.target.result);
            const tx = db.transaction(["munis", "cards"], "readwrite");
            
            // Restaura os munic√≠pios
            if (d.munis) {
                d.munis.forEach(m => tx.objectStore("munis").put(m));
            }

            // Restaura os cards (Benefici√°rios)
            d.cards.forEach(c => {
                // Fun√ß√£o b2b atualizada para aceitar o tipo do arquivo (imagem ou pdf)
                const b2b = (b, type) => {
                    if (!b) return null;
                    try {
                        const s = atob(b.split(',')[1]); 
                        const u = new Uint8Array(s.length);
                        for (let i = 0; i < s.length; i++) u[i] = s.charCodeAt(i);
                        return new Blob([u], { type: type });
                    } catch (err) {
                        console.error("Erro ao converter arquivo base64", err);
                        return null;
                    }
                };

                // Restaura Fotos (f1b e f2b)
                if (c.f1b) c.f1 = b2b(c.f1b, "image/jpeg");
                if (c.f2b) c.f2 = b2b(c.f2b, "image/jpeg");

                // Restaura PDF (pdfB)
                if (c.pdfB) c.docPdf = b2b(c.pdfB, "application/pdf");

                // Limpa as vers√µes tempor√°rias de texto para n√£o pesar o banco
                delete c.f1b; 
                delete c.f2b; 
                delete c.pdfB;

                // Salva o card atualizado no IndexedDB
                tx.objectStore("cards").put(c);
            });

            tx.oncomplete = () => { 
                alert("Restaura√ß√£o conclu√≠da com sucesso!"); 
                location.reload(); 
            };
        } catch (err) {
            console.error(err);
            alert("Erro ao processar o arquivo de backup. Verifique se o arquivo est√° correto.");
        }
    };
    reader.readAsText(input.files[0]);
}


    function importarArquivo() {
        const input = document.getElementById('fImport');
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const linhas = e.target.result.split(/\r?\n/);
            const tx = db.transaction("cards", "readwrite");
            linhas.forEach((l, i) => {
                if (i === 0 || !l.trim()) return;
                const c = l.split(/[;,]/);
                tx.objectStore("cards").put({ 
                    muni: muniAtual, nome: (c[0]||"").toUpperCase().trim(), cpf: (c[1]||"").trim(), 
                    com: (c[2]||"").toUpperCase().trim(), placa: (c[3]||"").trim(),
                    tel: "", gps: "", pedNome: "", pedCpf: "",
                    paga: false, pedPaga: false, f1: null, f2: null, 
                    impresso: false, lixeira: false, timestamp: Date.now() + i 
                });
            });
            tx.oncomplete = () => { alert("Importado!"); render(); };
        };
        reader.readAsText(input.files[0]);
    }
    function esvaziarLixeiraPermanente() {
        if(confirm("Esvaziar lixeira permanentemente?") && prompt("Senha:") === 'admin') {
            const tx = db.transaction("cards", "readwrite");
            const store = tx.objectStore("cards");
            store.getAll().onsuccess = e => {
                e.target.result.filter(c => c.muni === muniAtual && c.lixeira).forEach(c => store.delete(c.cpf));
                tx.oncomplete = () => { alert("Lixeira limpa!"); render(); };
            };
        }
    }

    function setTab(t) { 
        aba = t; 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        const target = document.getElementById('tab' + t);
        if(target) target.classList.add('active'); 
        render(); 
    }

    function alternarVisao(f) { 
        vistaFin = f; 
        document.getElementById('abasFisico').style.display = f ? 'none' : 'flex'; 
        document.getElementById('abasFinan').style.display = f ? 'flex' : 'none'; 
        setTab(f ? 'FP' : 'P'); 
    }

    function handleCPF(i) { 
        let v = i.value.replace(/\D/g, ""); 
        v = v.replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2"); 
        i.value = v; 
    }


            function limparFormulario() { 
        // Adicionado addNIS e addCurso na limpeza
        ['addN', 'addC', 'addCom', 'addP', 'addT', 'addG', 'addNIS', 'addPed', 'addPedC'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = "";
        }); 
        const checkCurso = document.getElementById('addCurso');
        if(checkCurso) checkCurso.checked = false;
        
        document.getElementById('addN').focus();
    }

    function fecharModal() { 
        document.getElementById('previewModal').style.display = 'none'; 
        // Limpa o conte√∫do para n√£o bugar a pr√≥xima abertura
        document.getElementById('modalContent').innerHTML = "";
    }

    function handleCPF(i) { 
        let v = i.value.replace(/\D/g, ""); 
        v = v.replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2"); 
        i.value = v; 
    }



        function dispararImp(id, tipo) {
    const tx = db.transaction("cards", "readwrite");
    const store = tx.objectStore("cards");
    
    store.get(id).onsuccess = e => {
        const c = e.target.result;
        if (!c || !c.f1 || !c.f2) return alert("Erro: Card sem fotos!");
        
        const getF = (f) => (f instanceof FileList && f.length > 0) ? f[0] : f;
        const u1 = URL.createObjectURL(getF(c.f1));
        const u2 = URL.createObjectURL(getF(c.f2));
        
        const win = window.open("", "_blank");
        
        // MODO SIGA: .pos-topo alterado para 4cm
        let css = (tipo === 'SIGA') 
            ? `.page { width: 210mm; height: 297mm; position: relative; page-break-after: always; } 
               .img-card { width: 15cm; height: 10cm; position: absolute; left: 50%; transform: translateX(-50%); border: 1px solid #000; object-fit: cover; }
               .pos-final { bottom: 2cm; } 
               .pos-topo { top: 4cm; }` // <--- ALTERADO PARA 4CM
            : `.page { width: 210mm; height: 297mm; position: relative; } 
               .img-card { width: 12cm; height: 9cm; position: absolute; left: 50%; transform: translateX(-50%); border: 1px solid #000; object-fit: cover; }
               .f1 { top: 3cm; } 
               .f2 { top: 13cm; }`;
        
        let html = (tipo === 'SIGA') 
            ? `<div class="page"><img src="${u1}" class="img-card pos-final"></div>
               <div class="page"><img src="${u2}" class="img-card pos-topo"></div>` 
            : `<div class="page">
                   <img src="${u1}" class="img-card f1">
                   <img src="${u2}" class="img-card f2">
               </div>`;
        
        win.document.write(`<html><head><style>@page { size: A4; margin: 0; } body { margin: 0; } ${css}</style></head>
            <body>${html}<script>window.onload=()=>{setTimeout(()=>{window.print();window.close();},1200);};<\/script></body></html>`);
        win.document.close();
        
        // Marca como impresso e salva
        c.impresso = true;
        store.put(c);
        tx.oncomplete = () => { fecharModal(); render(); };
    };
}


    function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if ((resto === 10) || (resto === 11)) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if ((resto === 10) || (resto === 11)) resto = 0;
    return resto === parseInt(cpf.substring(10, 11));
}
function upF(id, i, campo) { 
    if(!i.files || i.files.length === 0) return; 
    
    const tx = db.transaction("cards", "readwrite"); 
    const s = tx.objectStore("cards"); 
    
    s.get(id).onsuccess = e => { 
        const d = e.target.result; 
        if(!d) return;

        // Salva o arquivo da foto (f1 ou f2)
        d[campo] = i.files[0]; 
        
        // --- PROTE√á√ÉO VERS√ÉO 1.8 ---
        // Garante que os campos novos n√£o fiquem 'undefined' ao salvar a foto
        // Se ficarem undefined, o card some das abas 'Com Curso' ou 'Sem Curso'
        if (d.curso === undefined) d.curso = false;
        if (d.nis === undefined) d.nis = "";
        if (d.lixeira === undefined) d.lixeira = false;

        s.put(d); 
        
        tx.oncomplete = () => {
            console.log("Foto adicionada com sucesso!");
            render(); // Recarrega a lista para mostrar a miniatura
        };
    };
}
function upPdf(id, i) {
    if(!i.files || i.files.length === 0) return;
    const arquivo = i.files[0];
    if(arquivo.type !== "application/pdf") return alert("Apenas PDF!");

    const tx = db.transaction("cards", "readwrite");
    const s = tx.objectStore("cards");
    s.get(id).onsuccess = e => {
        const d = e.target.result;
        d.docPdf = arquivo;
        s.put(d);
        tx.oncomplete = () => { alert("PDF Salvo!"); render(); };
    };
}

function abrirPdf(id) {
    db.transaction("cards").objectStore("cards").get(id).onsuccess = e => {
        const d = e.target.result;
        if(!d.docPdf) return alert("Sem PDF!");
        window.open(URL.createObjectURL(d.docPdf), "_blank");
    };
}

</script>
</body>

</html>




